# app/pages/web_exploits_page.py
import logging
from PyQt6.QtWidgets import QWidget, QPushButton, QLabel, QLineEdit, QTextEdit, QComboBox
from PyQt6.QtCore import pyqtSignal, QSize, Qt, QThreadPool
from PyQt6.QtGui import QPixmap, QIcon, QShortcut, QKeySequence
from app.core.base_worker import CommandWorker

class WebExploitsPage(QWidget):
    navigate_signal = pyqtSignal(str)

    def __init__(self, parent=None):
        super().__init__(parent)
        self.main_window = parent
        self.setObjectName("WebExploitsPage")

        self.background_label = QLabel(self)
        self.background_label.setScaledContents(True)

        # --- Create UI Elements ---
        self.title = QLabel("Web & App Exploits", self)
        self.title.setObjectName("TitleLabel")
        
        self.back_button = QPushButton("< Back", self)
        self.back_button.setProperty("class", "backButton")
        self.back_button.clicked.connect(lambda: self.navigate_signal.emit("home"))
        
        self.target_input = QLineEdit(self)
        self.target_input.setObjectName("TargetInput")
        self.target_input.setPlaceholderText("Enter target URL (e.g., http://example.com)")
        
        self.param_input = QLineEdit(self)
        self.param_input.setObjectName("TargetInput")
        self.param_input.setPlaceholderText("Parameter (e.g., page, id)")

        self.terminal_output = QTextEdit(self)
        self.terminal_output.setObjectName("InfoPanel")
        self.terminal_output.setReadOnly(True)

        # --- Web Exploit Tool Buttons ---
        self.exploit_buttons_data = [
            {"id": "test_xss", "text": "XSS TEST", "rect": (135, 225, 105, 30)},
            {"id": "test_lfi", "text": "LFI/RFI", "rect": (135, 283, 105, 30)},
            {"id": "test_traversal", "text": "DIR TRAVERSAL", "rect": (135, 341, 105, 30)},
            {"id": "test_cmd_inject", "text": "CMD INJECT", "rect": (135, 398, 105, 30)},
            {"id": "extract_tokens", "text": "CSRF TOKENS", "rect": (135, 458, 105, 30)},
            {"id": "test_all", "text": "ALL TESTS", "rect": (135, 518, 105, 30)},
        ]

        self.exploit_buttons = []
        for button_data in self.exploit_buttons_data:
            button = QPushButton(button_data["text"], self)
            button.setProperty("class", "dnsToolButton")
            
            if button_data["id"] == "test_xss":
                button.clicked.connect(self.test_xss)
            elif button_data["id"] == "test_lfi":
                button.clicked.connect(self.test_lfi)
            elif button_data["id"] == "test_traversal":
                button.clicked.connect(self.test_directory_traversal)
            elif button_data["id"] == "test_cmd_inject":
                button.clicked.connect(self.test_command_injection)
            elif button_data["id"] == "extract_tokens":
                button.clicked.connect(self.extract_csrf_tokens)
            elif button_data["id"] == "test_all":
                button.clicked.connect(self.test_all_exploits)
                
            self.exploit_buttons.append(button)

        self.setup_shortcuts()
        self.resizeEvent(None)
        self.apply_theme()
        self.setFocusPolicy(Qt.FocusPolicy.StrongFocus)

    def resizeEvent(self, event):
        if event: super().resizeEvent(event)
        
        self.background_label.setGeometry(0, 0, self.width(), self.height())
        
        new_size = self.main_window.size()
        original_size = self.main_window.original_size
        ws = new_size.width() / original_size.width()
        hs = new_size.height() / original_size.height()

        self.title.setGeometry(int(340 * ws), int(40 * hs), int(400 * ws), int(50 * hs))
        self.back_button.setGeometry(int(20 * ws), int(20 * hs), int(150 * ws), int(50 * hs))
        
        term_x, term_y, term_w, term_h = 340, 175, 1731 - 340, 770 - 175
        self.terminal_output.setGeometry(term_x, term_y, term_w, term_h)

        controls_y = term_y + term_h + 20
        control_height = 36
        
        self.target_input.setGeometry(term_x, controls_y, 400, control_height)
        self.param_input.setGeometry(term_x + 420, controls_y, 200, control_height)

        for i, button in enumerate(self.exploit_buttons):
            x, y, w, h = self.exploit_buttons_data[i]["rect"]
            button.setGeometry(x, y, w, h)

    def apply_theme(self):
        theme = self.main_window.theme_manager
        bg_path = theme.get("backgrounds.enumeration")
        if bg_path: self.background_label.setPixmap(QPixmap(bg_path))

    def append_terminal_output(self, text):
        self.terminal_output.insertHtml(text)
        self.terminal_output.verticalScrollBar().setValue(self.terminal_output.verticalScrollBar().maximum())

    def set_buttons_enabled(self, enabled):
        for button in self.exploit_buttons:
            button.setEnabled(enabled)

    def show_error(self, message):
        self.terminal_output.setHtml(f"<p style='color: #FF4500;'>[ERROR] {message}</p>")

    def run_exploit_command(self, cmd, description):
        target = self.target_input.text().strip()
        if not target:
            return self.show_error("Please enter a target URL")
        
        self.terminal_output.clear()
        self.set_buttons_enabled(False)
        
        full_cmd = cmd + [target]
        worker = CommandWorker(full_cmd, description, str(self.main_window.project_root))
        worker.signals.output.connect(self.append_terminal_output)
        worker.signals.error.connect(self.append_terminal_output)
        worker.signals.finished.connect(lambda: self.set_buttons_enabled(True))
        QThreadPool.globalInstance().start(worker)

    def test_xss(self):
        cmd = ["python", "tools/web_exploits.py", "--xss"]
        self.run_exploit_command(cmd, "Testing for XSS vulnerabilities")

    def test_lfi(self):
        cmd = ["python", "tools/web_exploits.py", "--lfi", "--rfi"]
        self.run_exploit_command(cmd, "Testing for LFI/RFI vulnerabilities")

    def test_directory_traversal(self):
        param = self.param_input.text().strip() or "page"
        cmd = ["python", "tools/web_exploits.py", "--dir-traversal"]
        self.run_exploit_command(cmd, f"Testing directory traversal on parameter '{param}'")

    def test_command_injection(self):
        cmd = ["python", "tools/web_exploits.py", "--cmd-inject"]
        self.run_exploit_command(cmd, "Testing for command injection vulnerabilities")

    def extract_csrf_tokens(self):
        cmd = ["python", "tools/web_exploits.py", "--csrf-tokens"]
        self.run_exploit_command(cmd, "Extracting CSRF tokens and nonces")

    def test_all_exploits(self):
        cmd = ["python", "tools/web_exploits.py", "--all"]
        self.run_exploit_command(cmd, "Running comprehensive web exploit tests")

    def setup_shortcuts(self):
        self.clear_shortcut = QShortcut(QKeySequence("Ctrl+L"), self)
        self.clear_shortcut.activated.connect(self.clear_terminal)
        
        self.back_shortcut = QShortcut(QKeySequence("Escape"), self)
        self.back_shortcut.activated.connect(lambda: self.navigate_signal.emit("home"))
    
    def clear_terminal(self):
        self.terminal_output.clear()